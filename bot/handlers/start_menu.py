from __future__ import annotations
from aiogram import Router
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command

from bot.handlers.yoga_feedback.constants import SURVEY_INTRO_TEXT
from bot.handlers.yoga_feedback.keyboards import kb_start_survey
from bot.keyboards import main_menu_kb

router = Router()

@router.message(Command("start"))
async def cmd_start(message: Message, db, cfg):
    await db.upsert_user(message.from_user.id, message.from_user.username, message.from_user.first_name)
    await message.answer(
        "‚ú® –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è! ‚ú®\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π, –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è.\n"
        "–ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥—ë—à—å:\n"
        "‚Ä¢	üåç –£—Ä–æ–∫–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∏ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–æ–≤ ‚Äî –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è –∏ –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.\n"
        "‚Ä¢	üßò‚Äç‚ôÄÔ∏è –ü—Ä–∞–∫—Ç–∏–∫–∏ –π–æ–≥–∏ ‚Äî —á—Ç–æ–±—ã –æ–±—Ä–µ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å —Ç–µ–ª–∞ –∏ —É–º–∞.\n"
        "‚Ä¢	üîÆ –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ ‚Äî –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–µ–±—è –∏ —Å–≤–æ–µ–≥–æ –ø—É—Ç–∏.\n"
        "‚Ä¢	üß† –ú–µ–Ω—Ç–æ—Ä—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥ —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º.\n"
        "–Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ —Ä–∞—Å—Ç–∏, –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–æ–≤–æ–µ –∏ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –≤ –≥–∞—Ä–º–æ–Ω–∏–∏ —Å —Å–æ–±–æ–π –∏ –º–∏—Ä–æ–º.\n"
        
        "–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è ü§ç  \n"
        "–Ø –∑–∞–¥–∞–º –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–¥–±–µ—Ä—É —Ñ–æ—Ä–º–∞—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Ç—Å–≤–∏—è –¥–ª—è —Ç–µ–±—è ‚ú®",
        reply_markup=main_menu_kb()
    )

@router.message(Command("menu"))
async def cmd_menu(message: Message):
    await message.answer("‚ú® –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è! ‚ú®\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π, –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è.\n"
        "–ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥—ë—à—å:\n"
        "‚Ä¢	üåç –£—Ä–æ–∫–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∏ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–æ–≤ ‚Äî –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è –∏ –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.\n"
        "‚Ä¢	üßò‚Äç‚ôÄÔ∏è –ü—Ä–∞–∫—Ç–∏–∫–∏ –π–æ–≥–∏ ‚Äî —á—Ç–æ–±—ã –æ–±—Ä–µ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å —Ç–µ–ª–∞ –∏ —É–º–∞.\n"
        "‚Ä¢	üîÆ –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ ‚Äî –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–µ–±—è –∏ —Å–≤–æ–µ–≥–æ –ø—É—Ç–∏.\n"
        "‚Ä¢	üß† –ú–µ–Ω—Ç–æ—Ä—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥ —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º.\n"
        "–Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ —Ä–∞—Å—Ç–∏, –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–æ–≤–æ–µ –∏ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –≤ –≥–∞—Ä–º–æ–Ω–∏–∏ —Å —Å–æ–±–æ–π –∏ –º–∏—Ä–æ–º.\n"
        
        "–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è ü§ç \n"
        "–Ø –∑–∞–¥–∞–º –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–¥–±–µ—Ä—É —Ñ–æ—Ä–º–∞—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Ç—Å–≤–∏—è –¥–ª—è —Ç–µ–±—è ‚ú®",
    reply_markup=main_menu_kb())

@router.callback_query(lambda c: c.data == "menu")
async def cb_menu(call: CallbackQuery):
    await call.message.edit_text("‚ú® –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è! ‚ú®\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∑–Ω–∞–Ω–∏–π, –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è.\n"
        "–ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥—ë—à—å:\n"
        "‚Ä¢	üåç –£—Ä–æ–∫–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∏ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–æ–≤ ‚Äî –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è –∏ –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.\n"
        "‚Ä¢	üßò‚Äç‚ôÄÔ∏è –ü—Ä–∞–∫—Ç–∏–∫–∏ –π–æ–≥–∏ ‚Äî —á—Ç–æ–±—ã –æ–±—Ä–µ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å —Ç–µ–ª–∞ –∏ —É–º–∞.\n"
        "‚Ä¢	üîÆ –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ ‚Äî –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–µ–±—è –∏ —Å–≤–æ–µ–≥–æ –ø—É—Ç–∏.\n"
        "‚Ä¢	üß† –ú–µ–Ω—Ç–æ—Ä—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥ —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º.\n"
        "–Ø —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ —Ä–∞—Å—Ç–∏, –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–æ–≤–æ–µ –∏ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –≤ –≥–∞—Ä–º–æ–Ω–∏–∏ —Å —Å–æ–±–æ–π –∏ –º–∏—Ä–æ–º.\n"
        
        "–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è ü§ç  \n"
        "–Ø –∑–∞–¥–∞–º –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–¥–±–µ—Ä—É —Ñ–æ—Ä–º–∞—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Ç—Å–≤–∏—è –¥–ª—è —Ç–µ–±—è ‚ú®", reply_markup=main_menu_kb())
    await call.answer()



@router.message(Command("feedback_test"))
async def feedback_test(message: Message):
    await message.answer(
        SURVEY_INTRO_TEXT,
        reply_markup=kb_start_survey(999).as_markup()
    )

@router.message(Command("run_feedback_job"))
async def run_feedback_job(message: Message, db, cfg):
    from bot.jobs import send_yoga_feedback_surveys
    await send_yoga_feedback_surveys(bot=message.bot, db=db, cfg=cfg)
    await message.answer("job executed")

# @router.callback_query()
# async def debug_any_callback(q: CallbackQuery):
#     print("DEBUG CALLBACK:", q.data)
#     await q.answer("ok")
